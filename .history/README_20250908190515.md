# 概要
- 本家Gemini PWA( https://github.com/ona-oni/geminipwa )に感銘を受けた他の人が、触発され自分用にいじった派生コードを公開しているリポジトリ
-  自前のAPIキーを用いてChat AIとやりとりを行うためのアプリ
## コンセプト
-  自非常に優れたAI Chatアプリである本家Gemini PWAを、今後の情勢変化（ご周知の通り、Chat AI界隈のモデルのパワーバランス変化は非常に速いので）が起きた場合でも持続的に使用できるよう押さえておきたい、という完全に個人的な目的（研究的な意図もあります）の元、対応APIを増やしたり等しています。
## ■ 利用方法（PWA）
-  当PWAはブラウザから以下のURLにて利用可能です：
https://titan823.github.io/geminipwa/#chat
-  使い方や分からないことがあれば、このリポジトリの「index.html」ファイルの内容をGoogle AI Studio等でAIにご提示の上お尋ねください。
-  質問例: 「このPWAの初めての使い方を教えて」「APIキー・システムプロンプト・ダミープロンプトって何？」「ユーザーデータの扱いはどうなってる？」

# 派生版 GeminiPWA(ti) の変更点・仕様・連絡事項（2025年8月時点）
*  （⚠️の数は重要度を指します）
*   ⚠️周知の通りGeminiのAPIの動作が不安定である状況を踏まえ、この環境では妥当なデバッグ結果が得られないと判断したため、当コードの編集を見送っております。
*   他の方のコードから更に良いところを学んでいきたいと思料しておりますが、大規模な変更はデバッグ環境が十全に整うのを待ったのちに作業する方が安全だと判断しました。2025/08/25、2025/08/30追記
*   ⚠️kinkan04氏のPWA（https://github.com/kinkan04/Gemini-PWA-Mk-II ）の校正機能が好評のため、こちらのリポジトリのコードにも（仕様をこちらに適合させつつ）移植・導入させていただきました。校正のほかにも自動的にテキストを差し替える用途などに役立つ大変有用な機能と存じます。有効化する場合、“その他設定→アプリの挙動を調整→上級ユーザー向けオプション→校正機能を使用する”をオンにし、セットアップしてください。2025/08/10
*   ⚠️⚠️⚠️⚠️⚠️試製版“Twin-engine”も実装されていますが、調整中のため使用しないでください。現段階においては、“Twin-engine設定を表示する”を有効化しないでください。
（使用方法を誤ると湯水のようにトークンを浪費する事態になり得ます）2025/07/19
*   ⚠️⚠️⚠️⚠️⚠️過去のセッション履歴やプロンプト等の重要なデータは、各ユーザー様の任意のタイミングでバックアップしていただきますようお願いいたします。 
*   ⚠️⚠️各ボタン類の表示/非表示は設定画面から選択可能です。
*   ⚠️APIプロバイダーのオプションにLLM Aggregatorを追加しました。OpenRouter（https://openrouter.ai/api/v1 ）などのAPIを使用して任意のモデルを利用することができます。どのアグリゲーターを用いるかはマニュアルでURLを指定します。利用を始める際は、まずは無料のモデルを用いてテストを行なってください。（デフォルトでオプションとして備えられているOpenRouter用モデルは無料使用可能です）
*   当機能はOpenRouterでの利用を念頭に置いておりますが、vercel.com,endpoints.anyscale.com,
together.ai,console.groq.com,fireworks.ai,hugging face.co,deepinfra.comといったドメインもアクセス許可しております。他方でセキュリティ上の懸念から、これら以外のドメインへのアクセスはブロックされます。
*   以下URL例
* OpenRouter https://openrouter.ai/api/v1
* together.ai https://api.together.xyz/v1
* Fireworks AI https://api.fireworks.ai/inference/v1
*   ⚠️今後の情勢の変化に備えて、ChatGPTへの対応を試みましたが、現時点では公式のサービスのほうが扱いやすい（かなりガードが厳しいという意味で）かと存じます。今件は試験的な実装であり、単にチャットで利用できるようにしただけの簡易的なものとなっております。
*   ⚠️OpenAI APIでは内部思考を直接返すスイッチは存在せず、「思考プロセス」と同等のフラグは現在のところ実装できておりません。
*   ⚠️PWAでDeepSeek、Claude(Anthropic API)、grok(xAI)のAPIを利用できるようにアップデート致しました。使用するAPIプロバイダー:に選択肢として表示されない場合、その他設定>挙動調整>API切替ボタン設定から選択肢を設定してください
*   本機能は試験的な実装です。 デバッグは全て便宜的な水準のみにとどまっており、完璧な動作を保証するものではありません。 不具合が生じた場合、予告なくロールバックいたします。
* ⚠️ Claudeのインターネットから情報を取得する機能は未実装です。チャット以外の機能に対応する予定もございません
* ※DeepSeek、Anthropic API、xAIが提供するサービスは全て有料です。
* Claudeの推論機能とダミーModelプロンプトは現在併用できません（推論を使わない場合は大丈夫です）
-  自分用メモ:OpusはSonnetの5倍のコスト。SonnetはHaikuのおよそ4倍のコスト。DeepSeekはR1ですらHaikuよりも大幅に安い。Command AはSonnetより若干安い程度で、使う意味は薄い。
-  Claudeの最新の料金表は　https://www.anthropic.com/pricing
-  Gemini用API課金管理
-  https://console.cloud.google.com/welcome/new?hl=ja&inv=1&invt=AbzdRA&project=gen-lang-client-0937440006
-  DeepSeek用API管理
-  https://platform.deepseek.com/api_keys
-  Anthropic用API管理
-  https://console.anthropic.com/settings/keys
-  OpenAI用 API課金管理
-  https://platform.openai.com/settings/organization/billing/overview
-  xAIのAPIコンソール
-  https://console.x.ai/
-  xAIのAPIドキュメント
-  https://docs.x.ai/docs/overview
### ■ 注意事項
-  本PWAを初めてのデバイスから使用する場合は、必ず無料モデルを用いて必要最低限の機能構成からテストしてください。
-  当フォークは私用目的のため、性質上、サポートは行われません。本コードの編集・仕様変更のプロセスにおいて予告・告知などは行いません。また、本コードの更新は予告なく終了致します。
-  本コードはスマホブラウザ上での使用を想定としております。アプリ化やWindows上でのローカル使用などについてはデバッグ致しておりません。
-  PWA使用中に解決困難な問題が生じた場合は本PWAに関するキャッシュを全て削除することを推奨致します。
-  各種データは必ず各ユーザー様のご裁量で保存を行なってください。当アプリはアプリ内での恒久的なデータ保存や自動バックアップは意図されておりません。
-  既に実装済みのAPIプロバイダー以外のプロバイダーの APIに対応する予定はございません。
-  本コードは本家（フォーク元）の後継となることを意図するものでは断じてございません。本家コードに対し異を唱える意図も、本家コードの開発を阻害する意図なども一切ございません。当然ながら、異なる設計理念の元でのプロジェクトであると思料しておりますので、本フォークはプルリクエストを行いません。私的使用を目的とするバリュエーションのひとつと捉えてください。
-  本家コードの製作者様を除き、ご質問・ご意見・ご要望は承りません。 また、本コードによって損害や影響が生じた場合においても、公開陣は一切の責任を負いません。
-  本コードの利用基準（本コードの改変、コードのフォーク、他コードへのコード流用など）は、本コードのフォーク元の基準に準拠致します。（MITライセンス）
## ■ 更新履歴
### 【2025/08/22】
微調整（ロールバック）
### 【2025/08/11】
-  7月26日版をアーカイブとしてブランチに格納
### 【2025/08/10】
-  『校正機能』をリポジトリ（https://github.com/kinkan04/Gemini-PWA-Mk-II ）より移入し追加
-  バグフィックス
### 【2025/08/05】
-  不具合のため以前の版へ差し戻し
### 【2025/08/01】
-  設定画面レイアウトの変更
-  メッセージ間の余白を縮小するオプション、およびユーザーメッセージの横幅を拡張するオプションを追加
-  当アプリでAIが出力したテキストを、指定したWebhook URLに対して転送する機能を追加しました。このアプリを外部のツールと連携することを目的とした機能です。
### 【2025/07/26】
-  バグフィックス
### 【2025/07/24】
-  バグフィックス
### 【2025/07/19】
-  試製版“Twin-engine”実装。調整中なのでまだ使用しないでください。
-  小型画面の端末での利用を想定し、AI応答バブルの横幅を右横へ拡張できるようにオプションを追加しました。
-  システムの自己修復能力を強化（watchdog搭載等）
-  不具合の修正
### 【2025/07/14】
-  “Twin-engine”実装前の最後の版をブランチに格納
### 【2025/07/10】
-  Grok4をモデルオプションへ追加
### 【2025/07/05】
-  設定画面のレイアウトを見直し、整理しました
-  不具合の修正
### 【2025/07/03】
-  メインのセッション画面の上部に存在したシステムプロンプトを廃止しました。
-  これにより、存在するシステムプロンプトは、設定画面から設定可能な共通システムプロンプト (全API共通)および、各API専用の固有システムプロンプトのみとなりました。
### 【2025/07/01】
-  「設定を保存」ボタンを押さずとも、設定の変更が直ちに適用されるオプションを“※取り扱い注意項目※”内に追加
-  セッション画面の上部のシステムプロンプト欄撤去前の最後の版をブランチでアーカイブ化
-  不具合の是正
### 【2025/06/30】
-  複数のAPIキーを使い分けたい場合に活用できる複数APIキー管理機能を追加いたしました。その他設定>挙動調整の中にその有効化オプションがあります。
-  軽微な修正
### 【2025/06/26】
-  マークダウン画像表示に対応（メッセージバブル内の適正な幅に収まるように）しました（コードブロック内にある場合は表示しません）
-  APIプロバイダーのオプションにDummy AIを追加。ユーザーの送信に対して自動的に空の応答を返す機能で、セッションを手動で構築したい場合のコスト削減に役立ちます。
### 【2025/06/22】
-  APIプロバイダーのオプションにLLM Aggregatorを追加
-  耐エラー性・信頼性向上のためグローバルなエラーハンドリングと強制リロード（エラーが起きた場合に自動でキャッシュクリア＆リロードを行い自己修復を試みる機能）を実装しました。1分間に3回JavaScriptエラーが発生した場合、アプリが何らかの異常な損傷を受けたと判断され、自動的に最新キャッシュから修復が試みられます。 これにより、自動的にPWAが最新版にアップデートされる場合がありますが、ご了承下さい
-  API切替ボタン設定をその他設定>挙動調整の中に移動しました。
### 【2025/06/21】
-  LLM Aggregator追加前の最後の版をブランチに追加
### 【2025/06/20】
-  grok(xAI)のAPIに対応しました
-  iOSからもテキストファイル類をメッセージに添付できるようになりました
-  Gemini以外のAPIに対しても送信した画像を認識させられるようにしました（画像認識に対応しているモデルのみ）
-  思考プロセス内に、[]と(# "")が現れると応答がハングアップしてしまう不具合を修正
### 【2025/06/18】
-  Gemini 2.5 Flash Lite Preview 06-17,Gemini 2.5 Flash,Gemini 2.5 Proをモデルオプションに追加
### 【2025/06/17】
-  Mermaidコードを用いた図示を描写できるようになりました（マーメイド記法やマインドマップ等）
-  ユーザーが過去のメッセージに添付したファイルを操作できるようになりました
-  xAIのAPI対応前最後の版をブランチにログとして格納
### 【2025/06/15】
-  画面が小型ないし横長の端末での利用を想定し、ヘッダー/フッターの縦幅を切り詰めるオプションを追加
-  履歴画面からセッションのインポートや全取込をした際に、各セッションのセッション名の頭に(取込) (全)や(取込) を付与するかを選べるオプションを、“挙動調整”に追加
-  「共通プロンプト」のチェックがオフでも、「API別プロンプト」が有効なら正しく適用されるように修正しました。
-  DeepSeekの思考プロセス内に、 []と(# "")が現れると応答がハングアップしてしまう不具合を修正
### 【2025/06/12】
-  「API切替ボタン設定」でチェックを外したAIは、「APIプロバイダー設定」の選択肢にも表示しないようにしました。
### 【2025/06/11】
-  ChatGPT(OpenAI API)のAPIを利用できるようにアップデート（試製）
### 【2025/06/09】
- 各API固有のシステムプロンプトを設けました。優先度は各API固有のシステムプロンプト>従来のシステムプロンプトです。この変更により、APIごとに特化したシステムプロンプトを出せるようになります。
- XSS対策セキュリティ（DOMPurifyの導入とmarked.js出力のサニタイズ、および入力値検証の強化）を施しました。なおこのPWAは「完全クライアント側実行」のため、サーバーサイド攻撃（CSRFやSQLインジェクション）のリスクは現時点で懸念無用と判断しております。
- OpenAI API対応前の最後の版をログとしてブランチ化
### 【2025/06/08】
- ヘッダーが狭くなっても⚙️ボタンが隠れないよう表示優先度を上げました
- “ズームを禁止する (テキスト入力時の自動ズーム防止)”機能を強化（ボタン類へのダブルタップによるズームを禁止）
### 【2025/06/07】
- Claude(Anthropic API)のAPIを利用できるようにアップデート
- ワンタッチでAPIを切り替えられるボタンをヘッダー/フッターに追加可能にするオプション実装
### 【2025/06/06】
- Anthropic API対応前の最後の版をログとしてブランチ化
- gemini-2.5-pro-preview-06-05をモデルオプションに追加
### 【2025/06/05】
- DeepSeekのストリーミングがなめらかかつ速度を柔軟に設定できるよう、再設計しました
### 【2025/06/01】
- 大量の意図しない不具合の是正
- 設定画面のUIのコンパクト化
- DeepSeekとGeminiとで、それぞれ固有の“パラメータ”および“アドバンスド”設定を持たせるようにしました
- これによりDeepSeekとGeminiとで別々のシステムプロンプトやダミープロンプトを設定したりできます
- ストリーミング出力に関する設定を“アドバンスド”の中に編入しました
- 「設定を保存しました」通知を無効にするオプションを“※取り扱い注意項目※”内に設けました
### 【2025/05/31】
- DeepSeekのAPIを利用できるようにアップデート
- 古いバージョンをブランチにログとして追加
### 【2025/05/30】
- 本家PWAの修正に準拠した修正（Thought summaries対応、streamingのバグ修正）
### 【2025/05/23】
- メッセージ削除時の確認ダイアログを無効にするオプションを追加
### 【2025/05/21】
- リトライ時の確認ダイアログを無効にするオプションを追加
- gemini-2.5-flash-preview-05-20をデフォルトモデルオプションに追加
### 【2025/05/20】
- AI間会話モード（セッション間リンク）追加しました。（後述）
- ダイスボタン（🎲）をフッターに追加しました。
- 設定画面・履歴画面のUIをコンパクト化しました。
### 【2025/05/18】
- メッセージフォントサイズの設定オプションを追加
- メッセージの折り畳み状態を記憶するオプションを追加
- コードブロックへコピーボタン追加
### 【2025/05/17】
- チャットアイコンに付属する名前の背景にバブルを設定できるよう機能追加
- ボタンレイアウトの整理・コンパクト化
- AI応答内の折り畳まれた（(# "")で囲われた）部分について、クリックすると内容が表示/非表示されるようになりました。
- メッセージ編集ツールバーに「貼付け」ボタンを追加
### 【2025/05/16】
- メッセージツールバー透明度のオプションを追加
- テキスト入力時の自動ズーム防止機能を追加しました。スマホ等でテキスト入力時に意図せずズームするのを防ぎます。
### 【2025/05/15】
- 「メッセージ送信/受信時の自動スクロール」をオン/オフするオプションを追加
- 設定画面の「※取り扱い注意項目※」セクションに、「全履歴削除」ボタンを追加
### 【2025/05/14】
- テーマにパステルカラー5種を追加
- ヘッダーにクリップボードスタックボタン🗒️を追加（セッション内でコピーボタンを押すと自動で累積的に欄にテキスト一時スタック）
- ヘッダーにスクロールの上下移動ボタン🔼🔽を追加
- SNS的なチャットアイコン機能を実装
- ワンタップ（多分）でクリップボードのテキストをメッセージ入力欄にペーストできるボタンを、入力欄の左隣に追加
### 【2025/05/13】
- ヘッダーに以下を追加：
  - セッション削除ボタン
  - セッションコピーボタン
  - メモ欄📝（テキスト一時保存用）
  - メッセージバブルの「**全表示/非表示（🖼️）**」ボタン（背景画像観賞用です）
  - 全セッションの一括インポート、一括エクスポートボタン
- 各メッセージに **折りたたみボタン** を追加
- **透明度設定の追加：**
  1. **メッセージバブルの透明度**
     - 設定画面に `0.0～1.0` の数値フィールドを追加（ステップ：0.05）
     - メッセージバブルの透明度が変更可能（※文字色は変更なし）
  2. **ヘッダーとフッターの透明度**
     - 同様に `0.0～1.0` の設定が可能（※文字色・アイコン色は変更なし）
     - チャット背景オーバーレイの透明度も変更可能
### 【2025/05/12】
- モデルオプションに **Gemini 2.5 Pro Preview 05-06** を追加
  ※Google Cloudに支払い方法の登録が必要です。
- 各出入力の下部に **ピンク色の「コピー」ボタン** を追加
---

- **コード量を抑えるため、コード内コメントを削除しました。**

# AI間会話モード（セッション間リンク）
概説:2つのチャット履歴を繋げ、一方のAIの返事をもう一方のAIへの質問として使い、AI同士の会話を仲介する機能です。バックグラウンドでもう一方のセッションを動かす事で行います。
セッションを跨ぐことでキャラクター同士を会話させたり、一方のAIにユーザーの代理を演じさせ自動で応答させたり、美咲先生同士を戦わせたりできます。
使い方:
1. 有効化: 設定（⚙️）で「セッション間リンク機能」をオン。
2. リンク: 履歴画面（☰）で、会話させたい2つの履歴の「🔗」ボタンを押してリンク（緑とピンクで表示）。
3. 実行: リンクしたどちらかのチャット画面を開き、フッターの「👥」ボタンを押す。
    * 現在のAIの返事が、もう一方のAIへの質問として自動送信。
    * その応答が、さらに現在のAIへの質問として自動送信され、最終結果が表示されます。
    * 処理中は「AI間会話処理中…」などと表示されます。
 - 各履歴には、このAI間のやり取りが通常のメッセージとして記録されます。
- AI同士の会話を行うという点をAI達に認識させるためには前振り・導入をする必要があります。
例:あなたにはこれから、他のAIと会話してもらいます。お題は“熊と虎のどちらが強いか”です。次の入力以降はユーザーの入力ではありません。では、始めましょう。）
- ※注意点:本機能は試験的かつ遊戯的な機能です。また、自明な点ですが、リンクに用いる両セッション分のトークンが消費されます。動作確認は必ず無料モデルを用いて検証してください。
- 出入力以外のリンクは行わないため、メッセージの編集やリトライなどをしたい場合、双方のセッションにて手動でメッセージを整える操作を行う必要があります。
- リンク中はどちらか一方のセッションのみを使用することを推奨いたします。
- ※ Max Tokensの設定が足りないと失敗します。（特に推論機能を用いる場合）また、一方の応答が失敗したり、空の応答が返った場合も失敗します。
---
# DeepSeekについて
- ⚠️PWAでDeepSeekのAPIを利用できるようにアップデート致しました。本機能は試験的な実装です。
デバッグは全て便宜的な水準のみにとどまっており、完璧な動作を保証するものではありません。
不具合が生じた場合、予告なく当該機能全体を除去するという事態も論外とは言えません。
- ⚠️DeepSeek APIは2025年5月現在、インターネットから情報を取得する機能を提供していません。API経由での画像やファイルの直接解析も非対応です。
- サポートされていないパラメータ：temperature、top_p、presence_penalty、frequency_penalty、logprobs。top_logprobs、temperature、top_p、presence_penalty、frequency_penalty を設定してエラーにはなりませんが、効果はありません。logprobs、を設定するとtop_logprobsエラーになります。文字送りの速度を制御する専用のパラメータは提供されていません。
- ※DeepSeekが提供するAPIは全て有料です。
- ※“DeepSeek APIエンドポイント機能”は形式的な実装であり、デバッグしておりません。（デバッグ環境が無いため）

以下はフォーク元リポジトリ（2025/05/15）のREADME.md全文です。

# Gemini PWA Client

このリポジトリは、PWA（Progressive Web App）で作られたGemini APIのクライアントアプリケーションです。  
PWAとは実体がhtmlなだけの簡易アプリです。ブラウザがあれば使えます。
単純な文字チャット機能だけでファイルや画像関連の機能はありません。

## 使い方

Github Pagesで公開されたこのページにアクセスするだけです。  

[index.htmlへのリンク(Github Pages)](https://ona-oni.github.io/geminipwa/)
※このリポジトリの内容が静的にアクセスできる

1. GeminiのAPIキーを準備。
2. 上のリンクにアクセス。
3. 設定画面にGemini APIキーを設定して設定を保存。
4. チャット画面からチャット。

## PCのローカルでホストする
Webサイト上のは信用ならんからローカルで使いたい！という人はWindowsのみ下記の方法で使えます。
1. このリポジトリの全ファイルをダウンロードして同じフォルダ内に配置  
（サイト上部の緑の「Code」から「Download ZIP」）
2. __winlocal.batを起動
3. batのプロンプトが開いている間はローカルhttpサーバーからindex.htmlへアクセス可能

## ブラウザからPWAをアプリとしてインストール(任意)
PWAアプリとしてインストールするとアプリアイコンを作成できます。  
ブラウザにより挙動は違いますが、アドレスバーの横や設定ボタンなどから「XXをインストール」の項目を探してください。    
(モバイル用Chromeなら「ホーム画面に追加」が上記操作に相当）  
インストールしなくてもブラウザはPWAアプリをPWAアプリとして扱います。

## ファイルの説明
* manifest.json : PWAアプリの定義
* index.html : アプリそのもの
* sw.js : PWAサービスワーカー(PWAアプリとしてのファイルキャッシュなどを管理)
* marked.js : マークダウン表示用ライブラリ(MIT Lic)  

sw.jsのおかげで一度アクセスしたらブラウザ内に必要ファイル(「index.html」や「manifest.json」など)がキャッシュされる  
一度キャッシュされたら、設定から更新しない限り更新されない

## データの保存と通信について
* 設定やチャット履歴含む全てのデータはローカルのIndexedDBに保存されます。  
（ブラウザの中のデータベース。Github Pagesの当リポジトリのオリジン)
* 通信はGeminiAPIとしか行いません。(検索機能はGemini側の機能です)
* 履歴は履歴一覧からテキストファイルとしてエクスポートできます  
逆(インポート)は今のところ~~できません~~できます  
注:現状、アップロードされたファイルはエクスポートtxtには含まれません

## Dependencies
This project uses the following third-party libraries:

*   **Marked.js:** [MIT License](https://github.com/markedjs/marked/blob/master/LICENSE.md) - Used for rendering Markdown.
