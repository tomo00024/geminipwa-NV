# Gemini PWA (拡張版: 多機能画像表示)

このプロジェクトは、[titan823/geminipwa](https://github.com/titan823/geminipwa) をフォークし、AI との対話中に動的に画像を生成・表示するための 2 つの異なるアプローチ（**推奨**と**実験的**）を実装した独自拡張バージョンです。

オリジナルの Gemini PWA クライアントが持つ豊富な機能に加え、AI による URL 生成の不安定さを解決し、より表現力豊かなチャット体験を実現することを目指しています。

**当 PWA はブラウザから以下の URL にて利用可能です：**

- **推奨版 (variant-b):** [https://tomo00024.github.io/geminipwa-NV/variant-b/](https://tomo00024.github.io/geminipwa-NV/variant-b/)

- _実験的機能非推奨版 (variant-a):_ [https://tomo00024.github.io/geminipwa-NV/variant-a/](https://tomo00024.github.io/geminipwa-NV/variant-a/)

---

## 🌟 実装された画像表示機能

この PWA には、2 つの異なる画像表示機能が実装されています。**通常のご利用には、安定性と柔軟性を両立した「1. 画像 URL プレースホルダー変換機能」を強く推奨します。**

### 1. 画像 URL プレースホルダー変換機能 (variant-b / 推奨)

AI の出力を安定させ、確実かつ柔軟な画像表示を実現するための、シンプルで堅牢な機能です。

#### 概要

- **仕組み:** AI には `{{img}}` のような特別な目印（プレースホルダー）を含む部分的なパス、または `http` から始まるフルの URL を出力させます。PWA 側でその目印を、**チャットごとに自動設定されたベース URL**に置換して画像を表示します。
- **メリット:**
  - **高安定性:** AI が苦手な URL の完全な構文生成を回避するため、URL の形式ミスが起こりづらいです。
  - **柔軟なベース URL 管理:** チャットの最初のメッセージに含まれる URL をそのチャット専用のベース URL として自動認識するため、**チャットごとに異なる画像サーバーを使い分ける**ことができ、設定を都度変更する手間がありません。
  - **表記揺れの自動補正:** `rena` や `ゆズ` といった AI 特有の表記揺れを、事前に登録した固有名詞リストに基づいて自動で正しいパス（`れな` `ゆず`）に正規化します。

#### 設定と使い方

1.  **基本設定を有効化:**

    - 設定画面で「**画像 URL 変換設定**」を開き、「**AI 応答内の画像 URL プレースホルダーを変換する**」を ON にします。

2.  **ベース URL の設定（2 通りの方法）:**

    - **A) チャットごとの自動設定（推奨）:**
      1.  「**最初のプロンプト内の URL をそのチャットのベース URL として使用する**」を ON にします。
      2.  新しいチャットを開始する際、最初のメッセージに画像のホスティング先 URL（例: `https://my-assets.netlify.app`）を含めて送信します。
      3.  これだけで、そのチャット内では AI が `{{img}}/path/to/image.png` と出力するだけで、自動的に画像が表示されるようになります。
    - **B) グローバル設定（フォールバック）:**
      - 上記 A の方法を使わない場合や、URL をプロンプトに含めたくない場合は、「**ベース URL**」の欄に共通で使いたい URL を入力しておくことで、それがすべてのチャットのデフォルト値として使用されます。

3.  **表記揺れ補正の設定（任意）:**

    - 「**登場人物・固有名詞リスト**」に、画像パスで使う名前（キャラクター名など）をカンマ区切りで登録します。（例: `れな, ゆず`）
    - 必要に応じて、「**URL 内のローマ字をカタカナに変換して補正する**」の ON/OFF を切り替えます。

4.  **AI への指示:**
    - AI へのプロンプトで、`![alt text]({{img}}/キャラクター名/服装/表情.avif)` や `![alt text](https://.../キャラクター名/服装/表情.png)` のような形式で画像 URL を出力するように指示します。

---

### 2. 小説シーンビジュアライザー (variant-a / 非推奨)

Gemini の**Function Calling (Tool Use)**機能を活用し、より複雑な条件で画像を動的に選択・表示する実験的な機能です。

#### 概要

- **仕組み:** 設定画面で画像 URL のテンプレートとパラメータ（キャラクター、服装、表情など）を JSON 形式で定義します。AI は会話の文脈を解釈し、最適なパラメータを Function Calling で選択して PWA に伝えます。PWA はその情報に基づいて画像 URL を組み立てて表示します。
- **設定方法:**
  1.  設定画面で「**小説シーンビジュアライザー (Gemini 専用)**」を有効にします。
  2.  画像 URL のテンプレートとパラメータを JSON で設定します。
  3.  「アドバンスド」設定内の「ダミー User プロンプト」に、Function Calling を強制する指示を追加します。
- **現状の課題と評価 (非推奨の理由):**
  - **出力文字数の減少:** Function Calling を併用すると、AI の応答テキストが著しく短くなる傾向があります。
  - **追加指示が必須:** 安定して動作させるには「`display_novel_image`を必ず選択してください.
    文字数を増やしてください。」といった、追加の指示（おまじない）が必要です。
  - **パラメータ選択の失敗:** AI が JSON で定義された選択肢（`enum`）を無視し、`私服`を`私-724`のように誤って出力することがあります。
  - **パフォーマンス:** Function Calling の処理が入るため、応答遅延やトークン消費量の増加が懸念されます。

#### まとめ

このアプローチは技術的に興味深いものの、現状では出力品質の低下という大きなデメリットを抱えています。そのため、**安定したテキスト品質と確実な画像表示を求める場合は、推奨機能である「画像 URL プレースホルダー変換機能」のご利用をお勧めします。**

---

## ライセンスとクレジット

このプロジェクトは、[titan823/geminipwa](https://github.com/titan823/geminipwa) のフォークです。オリジナルのプロジェクトおよびその先行プロジェクトに深く感謝いたします。

- **フォーク元:** [titan823/geminipwa](https://github.com/titan823/geminipwa)
- **本家:** [ona-oni/geminipwa](https://github.com/ona-oni/geminipwa)

本プロジェクトの利用基準（改変、再配布、コードの流用など）は、フォーク元の基準である **MIT ライセンス** に準拠します。

### 依存ライブラリ

- **Marked.js:** [MIT License](https://github.com/markedjs/marked/blob/master/LICENSE.md)

---

### 重要事項・免責事項

- このフォークは、個人的な利用のために作成されたものであり、オリジナルの `geminipwa` プロジェクトとは独立しています。
- 本プロジェクトは**サポートを提供しません**。また、予告なく仕様変更や更新が終了する可能性があります。
- 初めてデバイスで使用する際は、必ず無料モデルを用いて必要最低限の機能構成からテストしてください。
- スマートフォンブラウザでの使用を想定しており、アプリ化や Windows 上でのローカル使用はデバッグされていません。
- 問題が発生した場合は、PWA のキャッシュ削除を試みてください。（設定 > アプリを更新 (キャッシュクリア)）
- セッション履歴やプロンプトなどのデータは永続的に保存されることを意図しておらず、自動バックアップ機能もありません。重要なデータはご自身でバックアップしてください。
- 本コードによって損害や影響が生じた場合においても、公開者は一切の責任を負いません。
